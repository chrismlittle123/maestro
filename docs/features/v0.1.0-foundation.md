# PRD: v0.1.0 - Foundation (MVP)

## Goal

Run a single workflow with one agent, end-to-end.

A user should be able to:

1. Initialize a Maestro project
2. Define a workflow with one step
3. Define an agent persona
4. Run the workflow and see the agent execute
5. View the output artifact

## Constraints

- Single agent per workflow (no multi-step yet)
- No approvals (full automation only)
- No error recovery
- Local only

---

## Features

### 1. Workflow YAML Parser

**Location:** `packages/core/src/workflow/parser.ts`

Parse workflow YAML files and validate with Zod.

```yaml
# workflows/example.yaml
name: example-workflow
description: A simple one-step workflow

steps:
  - id: generate
    agent: developer
    inputs: []
    outputs:
      - result.md
```

**Implementation:**

- `parseWorkflow(yamlContent: string): WorkflowConfig` - parse and validate
- `loadWorkflow(filePath: string): Promise<WorkflowConfig>` - load from file
- Zod schema already exists in `types/workflow.ts`

**Acceptance Criteria:**

- [ ] Parses valid YAML into WorkflowConfig
- [ ] Throws descriptive errors for invalid YAML
- [ ] Validates required fields (name, steps, step.id, step.agent)

---

### 2. Agent Markdown Parser

**Location:** `packages/core/src/agent/parser.ts`

Parse agent markdown files with YAML frontmatter using gray-matter.

```markdown
# agents/developer.md

---

name: developer
role: Software Developer
automation: full

---

## Identity

You are a senior software developer...

## Guidelines

- Follow best practices
- Write clean code
```

**Implementation:**

- `parseAgent(markdownContent: string): AgentDefinition` - parse and validate
- `loadAgent(filePath: string): Promise<AgentDefinition>` - load from file
- Return both config (frontmatter) and prompt (body)

```typescript
interface AgentDefinition {
  config: AgentConfig; // from frontmatter
  prompt: string; // markdown body
}
```

**Acceptance Criteria:**

- [ ] Parses frontmatter into AgentConfig
- [ ] Extracts markdown body as prompt string
- [ ] Validates required frontmatter fields (name, role)

---

### 3. In-Memory Event Bus

**Location:** `packages/core/src/events/event-bus.ts`

Simple pub/sub event bus for workflow events.

**Implementation:**

```typescript
class InMemoryEventBus implements EventBus {
  private handlers: Map<string, Set<EventHandler>>;
  private anyHandlers: Set<EventHandler>;

  emit(event: MaestroEvent): Promise<void>;
  on(eventType: string, handler: EventHandler): void;
  onAny(handler: EventHandler): void;
  off(eventType: string, handler: EventHandler): void;
}
```

**Events to support:**

- `workflow.started`
- `workflow.completed`
- `workflow.failed`
- `step.started`
- `step.completed`
- `step.failed`

**Acceptance Criteria:**

- [ ] Handlers receive events of subscribed type
- [ ] `onAny` handlers receive all events
- [ ] Handlers can be removed with `off`
- [ ] Async handlers are awaited

---

### 4. File System Artifact Storage

**Location:** `packages/core/src/artifacts/file-store.ts`

Store artifacts in `~/.maestro/artifacts/<workflow-run-id>/`.

**Implementation:**

```typescript
class FileSystemArtifactStore implements ArtifactStore {
  constructor(baseDir: string); // default: ~/.maestro/artifacts

  save(artifact: Artifact, content: Buffer | string): Promise<void>;
  load(artifactId: string): Promise<Buffer>;
  list(workflowId: string): Promise<Artifact[]>;
  get(artifactId: string): Promise<Artifact | null>;
  delete(artifactId: string): Promise<void>;
  deleteWorkflow(workflowId: string): Promise<void>;
}
```

**Directory structure:**

```
~/.maestro/
‚îú‚îÄ‚îÄ artifacts/
‚îÇ   ‚îî‚îÄ‚îÄ 2024-12-11-abc123/
‚îÇ       ‚îú‚îÄ‚îÄ manifest.json
‚îÇ       ‚îî‚îÄ‚îÄ step-generate/
‚îÇ           ‚îî‚îÄ‚îÄ result.md
‚îî‚îÄ‚îÄ logs/
    ‚îî‚îÄ‚îÄ 2024-12-11-abc123.log
```

**Acceptance Criteria:**

- [ ] Creates directories as needed
- [ ] Saves artifacts with correct paths
- [ ] Loads artifacts by ID
- [ ] Lists all artifacts for a workflow run
- [ ] Generates manifest.json with run metadata

---

### 5. Manifest Generation

**Location:** `packages/core/src/artifacts/manifest.ts`

Generate manifest.json for each workflow run.

```json
{
  "id": "2024-12-11-abc123",
  "workflowName": "example-workflow",
  "status": "completed",
  "startedAt": "2024-12-11T10:00:00Z",
  "completedAt": "2024-12-11T10:05:00Z",
  "steps": [
    {
      "id": "generate",
      "agent": "developer",
      "status": "completed",
      "startedAt": "2024-12-11T10:00:00Z",
      "completedAt": "2024-12-11T10:05:00Z",
      "artifacts": ["step-generate/result.md"]
    }
  ]
}
```

**Acceptance Criteria:**

- [ ] Created at workflow start
- [ ] Updated after each step completes
- [ ] Includes timing information
- [ ] Lists all artifacts produced

---

### 6. Claude Code SDK Adapter

**Location:** `packages/core/src/executors/claude-code-executor.ts`

Execute agents using the Claude Code SDK.

**Implementation:**

```typescript
class ClaudeCodeExecutor implements AgentExecutor {
  async execute(input: AgentExecutionInput): Promise<AgentExecutionOutput> {
    // 1. Build prompt from agent definition + workflow context
    // 2. Call Claude Code SDK
    // 3. Capture output
    // 4. Return artifacts
  }

  async cancel(workflowId: string, stepId: string): Promise<void>;
  async getStatus(workflowId: string, stepId: string): Promise<ExecutionStatus>;
}
```

**Acceptance Criteria:**

- [ ] Executes agent with combined prompt (persona + task)
- [ ] Captures agent output as artifact
- [ ] Returns success/failure status
- [ ] Tracks token usage (if available)

---

### 7. Workflow Engine Updates

**Location:** `packages/core/src/workflow-engine.ts`

Orchestrate single-step workflow execution.

**Implementation:**

```typescript
class WorkflowEngine {
  async run(workflowName: string, input: string): Promise<WorkflowRun> {
    // 1. Load workflow config
    // 2. Load agent definition
    // 3. Emit workflow.started
    // 4. Execute agent
    // 5. Save artifacts
    // 6. Update manifest
    // 7. Emit workflow.completed or workflow.failed
    // 8. Return run result
  }
}
```

**Acceptance Criteria:**

- [ ] Loads workflow and agent from files
- [ ] Emits correct events in order
- [ ] Saves output artifacts
- [ ] Generates manifest
- [ ] Returns run with status and artifact paths

---

### 8. CLI: maestro init

**Location:** `packages/cli/src/commands/init.ts`

Scaffold a new Maestro project.

**Creates:**

```
my-project/
‚îú‚îÄ‚îÄ workflows/
‚îÇ   ‚îî‚îÄ‚îÄ example.yaml
‚îú‚îÄ‚îÄ agents/
‚îÇ   ‚îî‚îÄ‚îÄ developer.md
‚îî‚îÄ‚îÄ maestro.config.yaml
```

**maestro.config.yaml:**

```yaml
workflowsDir: ./workflows
agentsDir: ./agents
artifactsDir: ~/.maestro/artifacts
```

**Acceptance Criteria:**

- [ ] Creates directory structure
- [ ] Generates example workflow
- [ ] Generates example agent
- [ ] Generates config file
- [ ] Does not overwrite existing files (prompts or errors)

---

### 9. CLI: maestro run

**Location:** `packages/cli/src/commands/run.ts`

Run a workflow.

**Usage:**

```bash
maestro run <workflow-name> --input "Build a login page"
```

**Output:**

```
üöÄ Starting workflow: feature-development
üìã Run ID: 2024-12-11-abc123

‚è≥ Step 1/1: generate (developer)
   Agent: developer
   Status: running...

‚úÖ Step completed in 45s
   Artifacts:
   - ~/.maestro/artifacts/2024-12-11-abc123/step-generate/result.md

üéâ Workflow completed successfully!
   Total time: 45s
   Artifacts: ~/.maestro/artifacts/2024-12-11-abc123/
```

**Acceptance Criteria:**

- [ ] Loads workflow by name from workflowsDir
- [ ] Shows spinner while agent runs
- [ ] Displays step progress
- [ ] Shows artifact locations on completion
- [ ] Shows error details on failure

---

### 10. CLI: maestro status

**Location:** `packages/cli/src/commands/status.ts`

Show status of workflow runs.

**Usage:**

```bash
# Show recent runs
maestro status

# Show specific run
maestro status 2024-12-11-abc123
```

**Output:**

```
Recent workflow runs:

ID                    Workflow              Status      Started
2024-12-11-abc123     feature-development   completed   2 min ago
2024-12-11-xyz789     bug-fix               failed      1 hour ago
```

**Acceptance Criteria:**

- [ ] Lists recent runs from manifest files
- [ ] Shows run details when ID provided
- [ ] Displays relative timestamps
- [ ] Shows artifact count per run

---

## Implementation Order

1. **Core infrastructure** (can be parallel):
   - Workflow parser
   - Agent parser
   - Event bus
   - File artifact store

2. **Execution** (depends on parsers):
   - Claude Code executor
   - Workflow engine integration

3. **CLI** (depends on execution):
   - `maestro init`
   - `maestro run`
   - `maestro status`

4. **Integration testing**:
   - End-to-end test: init ‚Üí run ‚Üí status

---

## Out of Scope for v0.1.0

- Multi-step workflows
- Human approvals
- Error recovery/retry
- Redis event bus
- S3 artifact storage
- Token/cost tracking
- Workflow persistence (resume after crash)
