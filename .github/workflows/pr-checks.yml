name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  branch-naming:
    name: Branch naming convention
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch name: $BRANCH_NAME"

          # Valid patterns: feature/*, fix/*, docs/*, chore/*, refactor/*, test/*
          VALID_PATTERN="^(feature|fix|docs|chore|refactor|test)/.+"

          if [[ ! "$BRANCH_NAME" =~ $VALID_PATTERN ]]; then
            echo "::error::Branch name '$BRANCH_NAME' does not follow the naming convention."
            echo "Please use one of: feature/*, fix/*, docs/*, chore/*, refactor/*, test/*"
            exit 1
          fi

          echo "Branch name follows the naming convention."

  pr-size:
    name: PR size check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          # Get the base branch
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Count changed lines (additions + deletions)
          CHANGED_LINES=$(git diff --shortstat $BASE_SHA $HEAD_SHA | awk '{print $4 + $6}')

          if [ -z "$CHANGED_LINES" ]; then
            CHANGED_LINES=0
          fi

          echo "Changed lines: $CHANGED_LINES"

          # Warn if PR is large (> 500 lines) but don't fail
          if [ "$CHANGED_LINES" -gt 500 ]; then
            echo "::warning::This PR has $CHANGED_LINES changed lines. Consider breaking it into smaller PRs for easier review."
          fi

  changeset-check:
    name: Changeset check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changeset
        run: |
          # Get new changeset files
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          CHANGESETS=$(git diff --name-only $BASE_SHA HEAD -- '.changeset/*.md' | grep -v 'README.md' || true)

          if [ -z "$CHANGESETS" ]; then
            echo "::warning::No changeset found. If this PR includes user-facing changes, please add a changeset using 'npx changeset'."
          else
            echo "Changeset found: $CHANGESETS"
          fi
